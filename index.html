<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sebastian Blue's Beautiful Music Quiz</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: white;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .container {
            max-width: 900px;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-top: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .settings {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .setting-item {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .setting-item input[type="checkbox"] {
            transform: scale(1.2);
        }

        .setting-item label {
            margin-right: 8px;
        }

        #mode-select {
            padding: 6px 8px;
            border-radius: 6px;
            border: none;
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
        }
        
        .file-input-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .file-input-label {
            background: #4a90e2;
            color: white;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-block;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .file-input-label:hover {
            background: #357ae8;
            transform: translateY(-2px);
        }
        
        #file-input {
            display: none;
        }
        
        .file-count {
            margin-top: 5px;
            font-size: 0.9rem;
            color: #ccc;
        }

        .scan-report {
            margin: 10px 0 20px 0;
            font-size: 0.9rem;
            color: #ffeb3b;
        }

        .scan-report ul {
            margin-top: 5px;
            padding-left: 20px;
        }

        .scan-report li {
            margin-bottom: 3px;
        }
        
        .demo-section {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .demo-btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .demo-btn:hover {
            background: #357ae8;
            transform: translateY(-2px);
        }
        
        .quiz-section {
            display: none;
        }
        
        .audio-player {
            display: flex;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .audio-player button {
            background: #ff5722;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .audio-player button:hover {
            background: #e64a19;
            transform: scale(1.05);
        }
        
        .audio-player button.secondary {
            background: #6c757d;
        }
        
        .audio-player button.secondary:hover {
            background: #5a6268;
        }

        .audio-player button.secondary:disabled {
            opacity: 0.5;
            transform: none;
            cursor: default;
        }
        
        .options-section {
            margin: 25px 0;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .option-btn {
            padding: 12px 15px;
            border-radius: 8px;
            border: 2px solid #4a90e2;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }
        
        .option-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .option-btn.correct {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4caf50;
        }
        
        .option-btn.incorrect {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
        }

        .option-btn.selected {
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.2);
        }

        .composer-year-container {
            margin-top: 10px;
            display: none;
        }

        .composer-year-container p {
            margin-bottom: 10px;
        }

        .composer-year-container input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
        }

        .composer-year-container label {
            display: block;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .composer-year-container select {
            width: 100%;
            padding: 8px 10px;
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            margin-bottom: 10px;
        }

        .composer-year-container button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .composer-year-container button:hover {
            background: #357ae8;
            transform: translateY(-2px);
        }
        
        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .correct-feedback {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4caf50;
        }
        
        .incorrect-feedback {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.95rem;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.5s;
        }
        
        .results {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .results h2 {
            margin-bottom: 20px;
            font-size: 2rem;
        }
        
        .score {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
            color: #4caf50;
        }
        
        .restart-btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .restart-btn:hover {
            background: #357ae8;
            transform: scale(1.05);
        }
        
        .review-section {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
        
        .review-btn {
            background: #ff9800;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .review-btn:hover {
            background: #e68900;
            transform: scale(1.05);
        }
        
        @media (min-width: 600px) {
            .options-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .stats {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <h1>Enhanced Music Recognition Quiz</h1>
    <div class="container">
        <div class="settings">
            <h3>Quiz Settings</h3>
            <div class="setting-item">
                <input type="checkbox" id="random-start">
                <label for="random-start">Start pieces from random positions</label>
            </div>
            <div class="setting-item">
                <input type="checkbox" id="review-missed" checked>
                <label for="review-missed">Review missed pieces at the end</label>
            </div>
            <div class="setting-item">
                <label for="mode-select">Quiz mode:</label>
                <select id="mode-select">
                    <option value="title">Multiple choice: piece title</option>
                    <option value="composer-year">Type: composer + year</option>
                    <option value="full">Full drill: title + composer + year + style (/4)</option>
                </select>
            </div>
        </div>
        
        <div class="file-input-section">
            <label for="file-input" class="file-input-label">Select Music Files</label>
            <input type="file" id="file-input" accept="audio/*" multiple>
            <div class="file-count" id="file-count">No files selected</div>
        </div>

        <div id="scan-report" class="scan-report"></div>
        
        <div class="demo-section">
            <button class="demo-btn" id="demo-btn">Try Demo First</button>
        </div>
        
        <div class="quiz-section" id="quiz-section">
            <div class="stats">
                <div>Progress: <span id="progress-text">0/0</span></div>
                <div>Score (points): <span id="score">0</span></div>
                <div>Missed pieces: <span id="missed-count">0</span></div>
            </div>
            
            <div class="progress-bar">
                <div class="progress" id="progress-bar"></div>
            </div>
            
            <div class="audio-player">
                <button id="play-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    Play Music
                </button>
                <button id="skip-btn" class="secondary">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                    </svg>
                    Skip to Middle
                </button>
                <button id="next-btn" class="secondary" disabled>
                    Next Piece
                </button>
            </div>
            
            <div class="options-section">
                <div class="options-grid" id="options-container">
                    <!-- Options generated here -->
                </div>

                <div class="composer-year-container" id="composer-year-container">
                    <p>
                        Type the <strong>composer</strong> and <strong>year</strong>, and (in full mode) choose the <strong>style</strong>:
                    </p>
                    <input type="text" id="composer-input" placeholder="Composer (e.g., Josquin des Prez)">
                    <input type="text" id="year-input" placeholder="Year (e.g., 1503)">
                    <label for="style-select">Style (only scored in full mode):</label>
                    <select id="style-select">
                        <option value="">-- choose style (optional) --</option>
                        <option value="chanson">Chanson</option>
                        <option value="carol">Carol</option>
                        <option value="motet">Motet</option>
                        <option value="mass">Mass</option>
                        <option value="madrigal">Madrigal</option>
                        <option value="chorale">Chorale</option>
                        <option value="anthem">Anthem</option>
                        <option value="ayre">Ayre (lute song)</option>
                        <option value="canzona">Canzona</option>
                        <option value="fantasia">Fantasia</option>
                        <option value="pavane">Pavane</option>
                        <option value="galliard">Galliard</option>
                        <option value="round">Round / canon</option>
                        <option value="dance">Instrumental dance</option>
                        <option value="carnival song">Carnival song / lauda</option>
                        <option value="lied">Lied / Tenorlied</option>
                        <option value="tune">Tune</option>
                    </select>
                    <button id="submit-composer-year">Submit Answer</button>
                </div>
            </div>
            
            <div class="feedback" id="feedback"></div>
        </div>
        
        <div class="results" id="results">
            <h2>Quiz Complete!</h2>
            <div class="score" id="final-score">0%</div>
            <p id="result-message">Great job! You know your music well.</p>
            <div class="review-section" id="review-section">
                <p>You missed <span id="missed-total">0</span> pieces. Would you like to review them?</p>
                <button class="review-btn" id="review-btn">Review Missed Pieces</button>
            </div>
            <button class="restart-btn" id="restart-btn">Try Again</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ===== DOM elements =====
            const fileInput = document.getElementById('file-input');
            const fileCount = document.getElementById('file-count');
            const scanReport = document.getElementById('scan-report');
            const demoBtn = document.getElementById('demo-btn');
            const quizSection = document.getElementById('quiz-section');
            const playBtn = document.getElementById('play-btn');
            const skipBtn = document.getElementById('skip-btn');
            const nextBtn = document.getElementById('next-btn');
            const optionsContainer = document.getElementById('options-container');
            const composerYearContainer = document.getElementById('composer-year-container');
            const composerInput = document.getElementById('composer-input');
            const yearInput = document.getElementById('year-input');
            const styleSelect = document.getElementById('style-select');
            const submitComposerYearBtn = document.getElementById('submit-composer-year');
            const feedback = document.getElementById('feedback');
            const progressText = document.getElementById('progress-text');
            const scoreElement = document.getElementById('score');
            const missedCountElement = document.getElementById('missed-count');
            const progressBar = document.getElementById('progress-bar');
            const results = document.getElementById('results');
            const finalScore = document.getElementById('final-score');
            const resultMessage = document.getElementById('result-message');
            const restartBtn = document.getElementById('restart-btn');
            const reviewSection = document.getElementById('review-section');
            const reviewBtn = document.getElementById('review-btn');
            const missedTotalElement = document.getElementById('missed-total');
            const randomStartCheckbox = document.getElementById('random-start');
            const reviewMissedCheckbox = document.getElementById('review-missed');
            const modeSelect = document.getElementById('mode-select');
            
            // ===== Quiz state =====
            let audioFiles = [];
            let currentAudioIndex = 0;
            let currentAudio = null;

            let score = 0;               // total points earned
            let totalPossiblePoints = 0; // max points so far
            let answeredCount = 0;       // how many questions fully graded
            let missedCount = 0;         // how many questions had something wrong

            let missedPieces = [];
            let isReviewRound = false;
            let quizMode = modeSelect.value;
            let questionLocked = false;

            let optionButtons = [];
            let selectedTitle = null;
            let currentCorrectInfo = null;
            let currentCorrectTitleAnswer = "";

            // ===== Sample music for demo mode =====
            const sampleMusic = [
                { name: "Douce dame jolie", composer: "Guillaume de Machaut", period: "Medieval" },
                { name: "Ave Maria...virgo serena", composer: "Josquin des Prez", period: "Renaissance" },
                { name: "Sumer is icumen in", composer: "Anonymous", period: "Medieval" },
                { name: "Can vei la lauzeta mover", composer: "Bernart de Ventadorn", period: "Medieval" },
                { name: "Viderunt omnes", composer: "Léonin", period: "Medieval" },
                { name: "Hoquetus David", composer: "Guillaume de Machaut", period: "Medieval" },
                { name: "Ja nuns hons pris ne dirat", composer: "Richard the Lionheart", period: "Medieval" },
                { name: "O rubor sanguinis", composer: "Hildegard von Bingen", period: "Medieval" }
            ];

            // ===== Canonical exam titles =====
            const EXAM_TITLES = [
                "Adieu ces bons vins de Lannoy",
                "Agincourt Carol",
                "Alma redemptoris mater",
                "As Vesta Was from Latmos Hill Descending",
                "Ave Maria",
                "Ave Maria...virgo serena",
                "Canzona 5",
                "Cruda, Amarilli",
                "De profundis clamavi",
                "Deuil angoisseus",
                "Ein feste Burg ist unser Gott",
                "Fantasia",
                "Flow my tears",
                "Galliard",
                "Giesu, sommo conforto",
                "Il bianco e dolce cigno",
                "In illo tempore loquente Jesu",
                "Innsbruck, ich muss dich lassen",
                "Je ne puis vivre ainsy toujours",
                "L’homme armé",
                "La Spagna",
                "Lux solempnis/Repleti sunt",
                "Miserere mei, deus",
                "Missa Benedicta es celorum regina",
                "Missa Caput",
                "Missa Hercules dux Ferrarie",
                "Missa L’homme armé",
                "Missa L’homme armé super voces musicales",
                "Missa Prolationum",
                "Moro, lasso",
                "Nuper rosarum flores",
                "O Lord, Make thy servant, Elizabeth",
                "Pastyme with Good Companye",
                "Pavane",
                "Prenez sur moy",
                "Quam pulchra es",
                "Resveilles vous",
                "Salve regina",
                "S’elle m’amera/Petite camusette",
                "Sumer is icumen in",
                "Tant que vivray",
                "Verbum bonum et suave",
                "Vultum tuum"
            ];

            // Map normalized title key -> canonical title string
            const TITLE_OVERRIDES = {};
            EXAM_TITLES.forEach(t => {
                TITLE_OVERRIDES[normalizeKey(t)] = t;
            });

            // Style overrides per (canonical) title
            const STYLE_OVERRIDES = {
                [normalizeKey("Adieu ces bons vins de Lannoy")]: "chanson",
                [normalizeKey("Agincourt Carol")]: "carol",
                [normalizeKey("Alma redemptoris mater")]: "motet",
                [normalizeKey("As Vesta Was from Latmos Hill Descending")]: "madrigal",
                [normalizeKey("Ave Maria")]: "motet",
                [normalizeKey("Ave Maria...virgo serena")]: "motet",
                [normalizeKey("Canzona 5")]: "canzona",
                [normalizeKey("Cruda, Amarilli")]: "madrigal",
                [normalizeKey("De profundis clamavi")]: "motet",
                [normalizeKey("Deuil angoisseus")]: "chanson",
                [normalizeKey("Ein feste Burg ist unser Gott")]: "chorale",
                [normalizeKey("Fantasia")]: "fantasia",
                [normalizeKey("Flow my tears")]: "ayre",
                [normalizeKey("Galliard")]: "galliard",
                [normalizeKey("Giesu, sommo conforto")]: "carnival song",
                [normalizeKey("Il bianco e dolce cigno")]: "madrigal",
                [normalizeKey("In illo tempore loquente Jesu")]: "motet",
                [normalizeKey("Innsbruck, ich muss dich lassen")]: "lied",
                [normalizeKey("Je ne puis vivre ainsy toujours")]: "chanson",
                [normalizeKey("L’homme armé")]: "tune",
                [normalizeKey("La Spagna")]: "dance",
                [normalizeKey("Lux solempnis/Repleti sunt")]: "motet",
                [normalizeKey("Miserere mei, deus")]: "motet",
                [normalizeKey("Missa Benedicta es celorum regina")]: "mass",
                [normalizeKey("Missa Caput")]: "mass",
                [normalizeKey("Missa Hercules dux Ferrarie")]: "mass",
                [normalizeKey("Missa L’homme armé")]: "mass",
                [normalizeKey("Missa L’homme armé super voces musicales")]: "mass",
                [normalizeKey("Missa Prolationum")]: "mass",
                [normalizeKey("Moro, lasso")]: "madrigal",
                [normalizeKey("Nuper rosarum flores")]: "motet",
                [normalizeKey("O Lord, Make thy servant, Elizabeth")]: "anthem",
                [normalizeKey("Pastyme with Good Companye")]: "part song",
                [normalizeKey("Pavane")]: "pavane",
                [normalizeKey("Prenez sur moy")]: "chanson",
                [normalizeKey("Quam pulchra es")]: "motet",
                [normalizeKey("Resveilles vous")]: "chanson",
                [normalizeKey("Salve regina")]: "motet",
                [normalizeKey("S’elle m’amera/Petite camusette")]: "chanson",
                [normalizeKey("Sumer is icumen in")]: "round",
                [normalizeKey("Tant que vivray")]: "chanson",
                [normalizeKey("Verbum bonum et suave")]: "motet",
                [normalizeKey("Vultum tuum")]: "motet"
            };

            // ===== Helper functions =====
            function normalizeKey(str) {
                return (str || "")
                    .toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "")
                    .replace(/[^a-z0-9]+/g, "");
            }

            function inferPeriodFromYearNumber(y) {
                if (!y || isNaN(y)) return "";
                if (y < 1400) return "Medieval";
                if (y < 1600) return "Renaissance";
                if (y < 1750) return "Baroque";
                return "";
            }

            function parseYearToken(token) {
                if (!token) return null;
                let t = token.toLowerCase().trim();
                t = t.replace(/^c\.?/,"");
                t = t.replace(/^ca\.?/,"");
                if (t.endsWith("s") && t.length >= 4) {
                    t = t.slice(0, -1);
                }
                const num = parseInt(t, 10);
                if (isNaN(num)) return null;
                return num;
            }

            // Parse filename into {title, composer, yearLabel, yearNumeric, period, style, displayName}
            function parseMusicInfoFromName(fileName) {
                let withoutExt = fileName.replace(/\.[^/.]+$/, "");
                let base = withoutExt.trim();

                // Remove any Wright-style prefixes if they ever sneak in
                base = base.replace(/^\d+-\d+\s+Wright no\. \d+_?\s*/, "");
                base = base.replace(/^\d+\s*-\s*/, "");

                const parts = base.split("_");
                let yearLabel = null;
                let yearNumeric = null;
                let composer = "";
                let titleRaw = "";

                if (parts.length === 1) {
                    titleRaw = parts[0];
                } else {
                    const possibleYearToken = parts[0];
                    const num = parseYearToken(possibleYearToken);
                    if (num !== null) {
                        yearLabel = possibleYearToken;
                        yearNumeric = num;
                        composer = (parts[1] || "").trim();
                        titleRaw = parts.slice(2).join(" ");
                    } else {
                        composer = parts[0].trim();
                        titleRaw = parts.slice(1).join(" ");
                    }
                }

                titleRaw = titleRaw.replace(/_/g, " ").trim();

                // Strip trailing style / instrumentation hints from the title itself
                // e.g. "Flow my tears ayre" -> "Flow my tears"
                const STRIP_PATTERNS = [
                    /ayre$/i,
                    /madrigal$/i,
                    /motet$/i,
                    /anthem$/i,
                    /chorale$/i,
                    /guitar solo$/i,
                    /4-voice setting$/i,
                    /Summer Canon$/i,
                    /VOICE \+ LUTE$/i,
                    /LUTE$/i,
                    /KEYBOARD$/i,
                    /part song$/i,
                    /tune.*$/i,
                    /dissonant madrigal$/i
                ];
                STRIP_PATTERNS.forEach(re => {
                    if (re.test(titleRaw)) {
                        titleRaw = titleRaw.replace(re, "").trim();
                    }
                });

                // Special mass / multi-movement cleanup
                let cleanTitle = titleRaw;

                // Normalize spaces
                cleanTitle = cleanTitle.replace(/\s+/g, " ");

                // Mass movement → whole mass
                if (/missa\s+l.?homme\s+arme/i.test(cleanTitle)) {
                    if (/super voces/i.test(cleanTitle)) {
                        cleanTitle = "Missa L’homme armé super voces musicales";
                    } else if (/sexti toni/i.test(cleanTitle)) {
                        cleanTitle = "Missa L’homme armé sexti toni";
                    } else {
                        cleanTitle = "Missa L’homme armé";
                    }
                } else if (/missa\s+benedicta/i.test(cleanTitle)) {
                    cleanTitle = "Missa Benedicta es celorum regina";
                } else if (/missa\s+caput/i.test(cleanTitle)) {
                    cleanTitle = "Missa Caput";
                } else if (/missa\s+hercules/i.test(cleanTitle)) {
                    cleanTitle = "Missa Hercules dux Ferrarie";
                } else if (/missa\s+prolationum/i.test(cleanTitle)) {
                    cleanTitle = "Missa Prolationum";
                }

                // Vultum tuum multi-movement titles
                if (/^vultum tuum/i.test(cleanTitle)) {
                    cleanTitle = "Vultum tuum";
                }

                // In illo tempore
                if (/in illo tempore loquente/i.test(cleanTitle)) {
                    cleanTitle = "In illo tempore loquente Jesu";
                }

                // Cruda Amarilli spelling
                if (/^cruda.? amarilli/i.test(cleanTitle)) {
                    cleanTitle = "Cruda, Amarilli";
                }

                // Canzona 5
                if (/canz[oz]ona 5/i.test(cleanTitle)) {
                    cleanTitle = "Canzona 5";
                }

                // Fantasia guitar solo => Fantasia
                if (/fantasia/i.test(cleanTitle)) {
                    cleanTitle = "Fantasia";
                }

                // Flow my tears
                if (/^flow my tears/i.test(cleanTitle)) {
                    cleanTitle = "Flow my tears";
                }

                // Galliard
                if (/galliard/i.test(cleanTitle)) {
                    cleanTitle = "Galliard";
                }

                // Pavane
                if (/pavane/i.test(cleanTitle)) {
                    cleanTitle = "Pavane";
                }

                // Ein feste Burg...
                if (/ein feste burg/i.test(cleanTitle)) {
                    cleanTitle = "Ein feste Burg ist unser Gott";
                }

                // Lux solemnis/Repleti sunt
                if (/lux solempnis/i.test(cleanTitle)) {
                    cleanTitle = "Lux solempnis/Repleti sunt";
                }

                // De profundis
                if (/de profundis/i.test(cleanTitle)) {
                    cleanTitle = "De profundis clamavi";
                }

                // Giesu sommo conforto
                if (/gies[uù],?\s*sommo conforto/i.test(cleanTitle)) {
                    cleanTitle = "Giesu, sommo conforto";
                }

                // Il bianco e dolce cigno
                if (/il bianco e dolce cigno/i.test(cleanTitle)) {
                    cleanTitle = "Il bianco e dolce cigno";
                }

                // Innsbruck
                if (/innsbruck,? ich muss dich lassen/i.test(cleanTitle)) {
                    cleanTitle = "Innsbruck, ich muss dich lassen";
                }

                // Je ne puis vivre
                if (/je ne puis vivre/i.test(cleanTitle)) {
                    cleanTitle = "Je ne puis vivre ainsy toujours";
                }

                // L'homme armé tune
                if (/l.?homme arme/i.test(cleanTitle) && /tune/i.test(titleRaw)) {
                    cleanTitle = "L’homme armé";
                }

                // La Spagna
                if (/la spagna/i.test(cleanTitle)) {
                    cleanTitle = "La Spagna";
                }

                // Nuper rosarum flores
                if (/nuper rosarum flores/i.test(cleanTitle)) {
                    cleanTitle = "Nuper rosarum flores";
                }

                // O Lord, make thy servant
                if (/o lord,? make thy servant/i.test(cleanTitle)) {
                    cleanTitle = "O Lord, Make thy servant, Elizabeth";
                }

                // Pastyme with Good Companye
                if (/pastyme with good companye/i.test(cleanTitle)) {
                    cleanTitle = "Pastyme with Good Companye";
                }

                // Prenez sur moy
                if (/prenez sur moy/i.test(cleanTitle)) {
                    cleanTitle = "Prenez sur moy";
                }

                // Quam pulchra es
                if (/quam pulchra es/i.test(cleanTitle)) {
                    cleanTitle = "Quam pulchra es";
                }

                // Resvellies vous
                if (/resvellies vous|resvellies vous et faites chiere lye/i.test(cleanTitle)) {
                    cleanTitle = "Resveilles vous";
                }

                // Salve regina
                if (/salve regina/i.test(cleanTitle)) {
                    cleanTitle = "Salve regina";
                }

                // S'elle m'amera / Petite camusette
                if (/s.?elle m.?amera/i.test(cleanTitle) || /petite camusette/i.test(cleanTitle)) {
                    cleanTitle = "S’elle m’amera/Petite camusette";
                }

                // Sumer is icumen in
                if (/sumer is icumen in/i.test(cleanTitle)) {
                    cleanTitle = "Sumer is icumen in";
                }

                // Tant que vivray
                if (/tant que vivray/i.test(cleanTitle)) {
                    cleanTitle = "Tant que vivray";
                }

                // Verbum bonum et suave
                if (/verbum bonum et suave/i.test(cleanTitle)) {
                    cleanTitle = "Verbum bonum et suave";
                }

                // Ave Maria variants
                if (/ave maria\.\.\./i.test(cleanTitle)) {
                    cleanTitle = "Ave Maria...virgo serena";
                } else if (/ave maria/i.test(cleanTitle)) {
                    cleanTitle = "Ave Maria";
                }

                // Deuil angoisseus
                if (/deuil angoisseus/i.test(cleanTitle)) {
                    cleanTitle = "Deuil angoisseus";
                }

                // Final canonicalization: map to exact exam title if present
                const key = normalizeKey(cleanTitle);
                const canonicalTitle = TITLE_OVERRIDES[key] || cleanTitle;

                // Style from overrides, if we know it
                const style = STYLE_OVERRIDES[key] || "";

                const period = yearNumeric ? inferPeriodFromYearNumber(yearNumeric) : "";

                const displayName = canonicalTitle;

                return {
                    title: canonicalTitle,
                    composer,
                    yearLabel,
                    yearNumeric,
                    period,
                    style,
                    displayName
                };
            }

            function getMusicInfo(item) {
                if (item instanceof File) {
                    return parseMusicInfoFromName(item.name);
                } else if (item && typeof item === "object") {
                    const title = item.displayName || item.name || "";
                    const composer = item.composer || "";
                    const period = item.period || "";
                    const key = normalizeKey(title);
                    const canonical = TITLE_OVERRIDES[key] || title;
                    const style = STYLE_OVERRIDES[key] || "";
                    return {
                        title: canonical,
                        composer,
                        yearLabel: null,
                        yearNumeric: null,
                        period,
                        style,
                        displayName: canonical
                    };
                } else {
                    return {
                        title: "",
                        composer: "",
                        yearLabel: null,
                        yearNumeric: null,
                        period: "",
                        style: "",
                        displayName: ""
                    };
                }
            }

            function composerMatches(input, expected) {
                const a = normalizeKey(input);
                const b = normalizeKey(expected);
                if (!a || !b) return false;
                if (a === b) return true;
                return (b.includes(a) || a.includes(b)) && a.length >= 3;
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            function registerQuestionResult(pointsEarned, maxPointsForQuestion) {
                score += pointsEarned;
                totalPossiblePoints += maxPointsForQuestion;
                answeredCount++;
                updateProgress();
            }

            function updateProgress() {
                const total = audioFiles.length || 0;
                progressText.textContent = `${answeredCount}/${total}`;
                scoreElement.textContent = score;
                missedCountElement.textContent = missedCount;

                const pct = total > 0 ? (answeredCount / total) * 100 : 0;
                progressBar.style.width = `${pct}%`;
            }

            function updateModeUI() {
                quizMode = modeSelect.value;
                if (quizMode === 'title') {
                    optionsContainer.style.display = 'grid';
                    composerYearContainer.style.display = 'none';
                } else if (quizMode === 'composer-year') {
                    optionsContainer.style.display = 'none';
                    composerYearContainer.style.display = 'block';
                } else if (quizMode === 'full') {
                    optionsContainer.style.display = 'grid';
                    composerYearContainer.style.display = 'block';
                }
            }

            function resetInputsForNewQuestion() {
                feedback.textContent = '';
                feedback.className = 'feedback';
                composerInput.value = '';
                yearInput.value = '';
                styleSelect.value = '';
                submitComposerYearBtn.disabled = false;
                selectedTitle = null;
                questionLocked = false;
                nextBtn.disabled = true;
            }

            function scanFilesForProblems() {
                if (audioFiles.length === 0) {
                    scanReport.textContent = "";
                    return;
                }
                if (!(audioFiles[0] instanceof File)) {
                    // demo mode; skip scan
                    scanReport.textContent = "";
                    return;
                }

                const problems = [];
                audioFiles.forEach((file, idx) => {
                    const info = getMusicInfo(file);
                    const name = file.name || `Item ${idx + 1}`;
                    const issues = [];
                    if (!info.title) issues.push("no title");
                    if (!info.composer) issues.push("no composer");
                    if (!info.yearLabel && !info.yearNumeric) issues.push("no year");
                    if (issues.length > 0) {
                        problems.push(`${name}: ${issues.join(", ")}`);
                    }
                });

                if (problems.length === 0) {
                    scanReport.textContent = "All files parsed with title, composer, and year.";
                } else {
                    scanReport.innerHTML = "<strong>Note:</strong> Some files are missing info (composer/year/title) and won't be fully graded:<ul>" +
                        problems.map(p => `<li>${p}</li>`).join("") +
                        "</ul>";
                }
            }

            // ===== Event listeners =====
            fileInput.addEventListener('change', handleFileSelection);
            demoBtn.addEventListener('click', startDemoQuiz);
            playBtn.addEventListener('click', playCurrentAudio);
            skipBtn.addEventListener('click', skipToMiddle);
            restartBtn.addEventListener('click', restartQuiz);
            reviewBtn.addEventListener('click', startReviewRound);
            nextBtn.addEventListener('click', () => {
                if (!questionLocked) {
                    feedback.textContent = "Make a guess before moving on (or this question won't be graded).";
                    feedback.className = "feedback incorrect-feedback";
                    return;
                }
                nextQuestion();
            });

            submitComposerYearBtn.addEventListener('click', () => {
                if (quizMode === 'composer-year') {
                    checkComposerYearAnswer();
                } else if (quizMode === 'full') {
                    checkFullAnswer();
                }
            });

            composerInput.addEventListener('keydown', handleComposerYearKey);
            yearInput.addEventListener('keydown', handleComposerYearKey);
            styleSelect.addEventListener('keydown', handleComposerYearKey);

            function handleComposerYearKey(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (quizMode === 'composer-year') {
                        checkComposerYearAnswer();
                    } else if (quizMode === 'full') {
                        checkFullAnswer();
                    }
                }
            }

            modeSelect.addEventListener('change', () => {
                if (!quizSection.style.display || quizSection.style.display === 'none') {
                    updateModeUI();
                }
            });

            updateModeUI();

            // ===== Core quiz logic =====
            function handleFileSelection(e) {
                const files = e.target.files;
                if (!files || files.length === 0) return;
                
                audioFiles = Array.from(files);
                fileCount.textContent = `${audioFiles.length} file(s) selected`;
                demoBtn.style.display = 'none';
                shuffleArray(audioFiles);
                scanFilesForProblems();
                startQuiz();
            }
            
            function startDemoQuiz() {
                audioFiles = sampleMusic.map((music, index) => {
                    return {
                        name: `${index + 1}-${music.name}.mp3`,
                        displayName: music.name,
                        composer: music.composer,
                        period: music.period
                    };
                });
                
                demoBtn.style.display = 'none';
                document.querySelector('.file-input-section').style.display = 'none';
                scanReport.textContent = "";
                startQuiz();
            }
            
            function startQuiz() {
                quizMode = modeSelect.value;
                updateModeUI();
                modeSelect.disabled = true;

                quizSection.style.display = 'block';
                results.style.display = 'none';

                currentAudioIndex = 0;
                score = 0;
                totalPossiblePoints = 0;
                answeredCount = 0;
                missedCount = 0;
                missedPieces = [];
                isReviewRound = false;
                resetInputsForNewQuestion();
                updateProgress();
                loadCurrentAudio();
            }
            
            function startReviewRound() {
                if (missedPieces.length === 0) return;
                
                audioFiles = missedPieces;
                results.style.display = 'none';
                quizSection.style.display = 'block';
                currentAudioIndex = 0;
                score = 0;
                totalPossiblePoints = 0;
                answeredCount = 0;
                missedCount = 0;
                isReviewRound = true;
                resetInputsForNewQuestion();
                updateProgress();
                loadCurrentAudio();
            }
            
            function loadCurrentAudio() {
                if (currentAudio) {
                    currentAudio.pause();
                    if (currentAudio.src && currentAudio.src.startsWith('blob:')) {
                        URL.revokeObjectURL(currentAudio.src);
                    }
                }
                
                const file = audioFiles[currentAudioIndex];
                
                if (file instanceof File) {
                    currentAudio = new Audio(URL.createObjectURL(file));
                    currentAudio.addEventListener('loadedmetadata', function() {
                        if (randomStartCheckbox.checked && currentAudio.duration > 10) {
                            const randomStartTime = Math.random() * (currentAudio.duration - 10) + 5;
                            currentAudio.currentTime = Math.min(randomStartTime, currentAudio.duration - 5);
                        }
                    });
                } else {
                    currentAudio = new Audio();
                }
                
                resetInputsForNewQuestion();
                generateQuestionUI();
            }

            function generateQuestionUI() {
                const infoList = audioFiles.map(item => getMusicInfo(item));
                currentCorrectInfo = infoList[currentAudioIndex];
                currentCorrectTitleAnswer = currentCorrectInfo.title || currentCorrectInfo.displayName;

                // Title options for title/full modes
                if (quizMode === 'title' || quizMode === 'full') {
                    optionsContainer.innerHTML = '';
                    optionButtons = [];
                    const allTitles = infoList.map(info => info.title || info.displayName);
                    const uniqueTitles = [...new Set(allTitles)];
                    const shuffled = [...uniqueTitles];
                    shuffleArray(shuffled);
                    
                    shuffled.forEach(answer => {
                        const button = document.createElement('button');
                        button.className = 'option-btn';
                        button.textContent = answer;
                        if (quizMode === 'title') {
                            button.addEventListener('click', () =>
                                checkTitleAnswer(answer, currentCorrectTitleAnswer, currentCorrectInfo, button)
                            );
                        } else if (quizMode === 'full') {
                            button.addEventListener('click', () =>
                                selectTitleForFullMode(answer, button)
                            );
                        }
                        optionsContainer.appendChild(button);
                        optionButtons.push(button);
                    });
                    optionsContainer.style.display = 'grid';
                } else {
                    optionsContainer.innerHTML = '';
                    optionsContainer.style.display = 'none';
                    optionButtons = [];
                }

                if (quizMode === 'composer-year' || quizMode === 'full') {
                    composerYearContainer.style.display = 'block';
                    composerInput.focus();
                } else {
                    composerYearContainer.style.display = 'none';
                }
            }

            function selectTitleForFullMode(answer, button) {
                if (questionLocked) return;
                selectedTitle = answer;
                optionButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
            }
            
            function playCurrentAudio() {
                const file = audioFiles[currentAudioIndex];
                
                if (file instanceof File) {
                    if (currentAudio) {
                        currentAudio.play().catch(e => {
                            feedback.textContent = "Error playing audio. Please try again.";
                            feedback.className = "feedback incorrect-feedback";
                        });
                    }
                } else {
                    const info = getMusicInfo(file);
                    feedback.textContent = `Now playing: ${info.title || file.displayName} (Demo)`;
                    feedback.className = "feedback correct-feedback";
                    
                    setTimeout(() => {
                        if (feedback.textContent.includes("Now playing")) {
                            feedback.textContent = "Audio finished. Make your selection!";
                            feedback.className = "feedback";
                        }
                    }, 3000);
                }
            }
            
            function skipToMiddle() {
                if (currentAudio && currentAudio.duration) {
                    const middleTime = currentAudio.duration / 2;
                    currentAudio.currentTime = middleTime;
                    
                    if (currentAudio.paused) {
                        currentAudio.play().catch(e => {
                            feedback.textContent = "Error playing audio. Please try again.";
                            feedback.className = "feedback incorrect-feedback";
                        });
                    }
                    
                    feedback.textContent = "Skipped to middle of piece";
                    feedback.className = "feedback";
                } else {
                    feedback.textContent = "Audio not ready yet. Please wait.";
                    feedback.className = "feedback incorrect-feedback";
                }
            }

            function checkTitleAnswer(selectedAnswer, correctAnswer, info, button) {
                if (questionLocked) return;
                questionLocked = true;

                optionButtons.forEach(btn => { btn.disabled = true; });
                
                let pointsEarned = 0;
                const maxPoints = 1;

                if (selectedAnswer === correctAnswer) {
                    pointsEarned = 1;
                    button.classList.add('correct');
                    feedback.textContent = "Correct! Well done!";
                    feedback.className = "feedback correct-feedback";
                    
                    if (info.title || info.composer || info.yearLabel || info.period) {
                        setTimeout(() => {
                            let html = `<div><strong>Correct!</strong><br>`;
                            if (info.title) html += `Piece: ${info.title}<br>`;
                            if (info.composer) html += `Composer: ${info.composer}<br>`;
                            if (info.yearLabel) html += `Year: ${info.yearLabel}<br>`;
                            if (info.period) html += `Period: ${info.period}<br>`;
                            if (info.style) html += `Style: ${info.style}<br>`;
                            html += `</div>`;
                            feedback.innerHTML = html;
                        }, 800);
                    }
                } else {
                    missedCount++;
                    button.classList.add('incorrect');
                    feedback.textContent = `Incorrect. The correct answer was: ${correctAnswer}`;
                    feedback.className = "feedback incorrect-feedback";
                    
                    const currentPiece = audioFiles[currentAudioIndex];
                    if (!isReviewRound && !missedPieces.includes(currentPiece)) {
                        missedPieces.push(currentPiece);
                    }
                    
                    optionButtons.forEach(btn => {
                        if (btn.textContent === correctAnswer) {
                            btn.classList.add('correct');
                        }
                    });
                    
                    if (info.title || info.composer || info.yearLabel || info.period) {
                        setTimeout(() => {
                            let html = `<div><strong>Incorrect.</strong> The correct answer was: ${correctAnswer}<br>`;
                            if (info.title) html += `Piece: ${info.title}<br>`;
                            if (info.composer) html += `Composer: ${info.composer}<br>`;
                            if (info.yearLabel) html += `Year: ${info.yearLabel}<br>`;
                            if (info.period) html += `Period: ${info.period}<br>`;
                            if (info.style) html += `Style: ${info.style}<br>`;
                            html += `</div>`;
                            feedback.innerHTML = html;
                        }, 800);
                    }
                }
                
                registerQuestionResult(pointsEarned, maxPoints);
                nextBtn.disabled = false;
            }

            function checkComposerYearAnswer() {
                if (questionLocked) return;
                questionLocked = true;
                submitComposerYearBtn.disabled = true;

                const info = currentCorrectInfo || getMusicInfo(audioFiles[currentAudioIndex]);
                const inputComposer = composerInput.value.trim();
                const inputYearStr = yearInput.value.trim();
                const expectedComposer = info.composer;
                const expectedYearNum = info.yearNumeric;

                const composerOK = expectedComposer ? composerMatches(inputComposer, expectedComposer) : false;
                let yearOK = true;
                let yearGraded = false;

                if (expectedYearNum) {
                    yearGraded = true;
                    const inputYearNum = parseInt(inputYearStr, 10);
                    yearOK = !isNaN(inputYearNum) && Math.abs(inputYearNum - expectedYearNum) <= 25;
                }

                // 2-point question: 1 for composer, 1 for year (if we know the year)
                let maxPoints = 0;
                if (expectedComposer) maxPoints += 1;
                if (yearGraded) maxPoints += 1;

                let pointsEarned = 0;
                if (composerOK) pointsEarned += 1;
                if (yearGraded && yearOK) pointsEarned += 1;

                const allCorrect = (composerOK || !expectedComposer) && (!yearGraded || yearOK);

                if (!allCorrect) {
                    missedCount++;
                    const currentPiece = audioFiles[currentAudioIndex];
                    if (!isReviewRound && !missedPieces.includes(currentPiece)) {
                        missedPieces.push(currentPiece);
                    }
                }

                let html = `<div><strong>${allCorrect ? 'Correct!' : 'Not quite.'}</strong><br>`;
                html += `Piece: ${info.title || '(unknown title)'}<br>`;
                if (expectedComposer) {
                    html += `Composer: ${expectedComposer} ${composerOK ? '✓' : `(your answer: ${inputComposer || '—'})`}<br>`;
                } else {
                    html += `Composer: (not stored in filename)`;
                    if (inputComposer) html += ` — you entered: ${inputComposer}`;
                    html += `<br>`;
                }

                if (yearGraded) {
                    html += `Year (±25 accepted): ${info.yearLabel || expectedYearNum} ${yearOK ? '✓' : `(your answer: ${inputYearStr || '—'})`}<br>`;
                } else {
                    html += `Year: (not stored for this file; not graded)<br>`;
                }

                if (info.style) {
                    html += `Style: ${info.style}<br>`;
                }
                if (info.period) {
                    html += `Period: ${info.period}<br>`;
                }

                html += `</div>`;
                feedback.innerHTML = html;
                feedback.className = allCorrect ? "feedback correct-feedback" : "feedback incorrect-feedback";

                registerQuestionResult(pointsEarned, maxPoints || 1); // avoid divide-by-zero

                nextBtn.disabled = false;
            }

            function checkFullAnswer() {
                if (questionLocked) return;
                questionLocked = true;
                submitComposerYearBtn.disabled = true;
                optionButtons.forEach(btn => btn.disabled = true);

                const info = currentCorrectInfo || getMusicInfo(audioFiles[currentAudioIndex]);
                const expectedTitle = currentCorrectTitleAnswer;
                const expectedComposer = info.composer;
                const expectedYearNum = info.yearNumeric;
                const expectedStyle = info.style;

                const inputComposer = composerInput.value.trim();
                const inputYearStr = yearInput.value.trim();
                const inputStyle = styleSelect.value;

                let maxParts = 0;
                if (expectedTitle) maxParts++;
                if (expectedComposer) maxParts++;
                if (expectedYearNum) maxParts++;
                if (expectedStyle) maxParts++;

                if (maxParts === 0) maxParts = 1; // safety

                let titleCorrect = false;
                let composerCorrect = false;
                let yearCorrect = false;
                let styleCorrect = false;

                if (expectedTitle) {
                    titleCorrect = (selectedTitle === expectedTitle);
                }

                if (expectedComposer) {
                    composerCorrect = composerMatches(inputComposer, expectedComposer);
                }

                if (expectedYearNum) {
                    const inputYearNum = parseInt(inputYearStr, 10);
                    yearCorrect = !isNaN(inputYearNum) && Math.abs(inputYearNum - expectedYearNum) <= 25;
                }

                if (expectedStyle) {
                    styleCorrect = normalizeKey(inputStyle) === normalizeKey(expectedStyle);
                }

                let pointsEarned = 0;
                if (titleCorrect) pointsEarned++;
                if (composerCorrect) pointsEarned++;
                if (yearCorrect) pointsEarned++;
                if (styleCorrect) pointsEarned++;

                const allCorrect = (
                    (!expectedTitle || titleCorrect) &&
                    (!expectedComposer || composerCorrect) &&
                    (!expectedYearNum || yearCorrect) &&
                    (!expectedStyle || styleCorrect)
                );

                if (!allCorrect) {
                    missedCount++;
                    const currentPiece = audioFiles[currentAudioIndex];
                    if (!isReviewRound && !missedPieces.includes(currentPiece)) {
                        missedPieces.push(currentPiece);
                    }
                }

                // Visuals: mark selected title correctness
                if (expectedTitle && optionButtons.length > 0) {
                    optionButtons.forEach(btn => {
                        if (btn.textContent === expectedTitle) {
                            btn.classList.add('correct');
                        }
                    });
                    if (selectedTitle) {
                        const btn = optionButtons.find(b => b.textContent === selectedTitle);
                        if (btn && selectedTitle !== expectedTitle) {
                            btn.classList.add('incorrect');
                        }
                    }
                }

                let html = `<div><strong>${allCorrect ? 'Perfect!' : 'Results:'}</strong><br>`;
                html += `Piece: ${info.title || '(unknown title)'}<br>`;

                if (expectedTitle) {
                    html += `Title: ${expectedTitle} ${titleCorrect ? '✓' : `(your choice: ${selectedTitle || '—'})`}<br>`;
                }

                if (expectedComposer) {
                    html += `Composer: ${expectedComposer} ${composerCorrect ? '✓' : `(your answer: ${inputComposer || '—'})`}<br>`;
                }

                if (expectedYearNum) {
                    html += `Year (±25 accepted): ${info.yearLabel || expectedYearNum} ${yearCorrect ? '✓' : `(your answer: ${inputYearStr || '—'})`}<br>`;
                }

                if (expectedStyle) {
                    html += `Style: ${expectedStyle} ${styleCorrect ? '✓' : `(your choice: ${inputStyle || '—'})`}<br>`;
                }

                if (info.period) {
                    html += `Period: ${info.period}<br>`;
                }

                html += `</div>`;
                feedback.innerHTML = html;
                feedback.className = allCorrect ? "feedback correct-feedback" : "feedback incorrect-feedback";

                registerQuestionResult(pointsEarned, maxParts);
                nextBtn.disabled = false;
            }

            function nextQuestion() {
                nextBtn.disabled = true;
                submitComposerYearBtn.disabled = false;
                questionLocked = false;
                selectedTitle = null;

                currentAudioIndex++;
                if (currentAudioIndex < audioFiles.length) {
                    loadCurrentAudio();
                } else {
                    finishQuiz();
                }
            }

            function finishQuiz() {
                quizSection.style.display = 'none';
                results.style.display = 'block';
                
                const pct = totalPossiblePoints > 0
                    ? Math.round((score / totalPossiblePoints) * 100)
                    : 0;
                finalScore.textContent = `${pct}%`;
                
                if (pct >= 90) {
                    resultMessage.textContent = "Outstanding! You're a Renaissance ninja.";
                } else if (pct >= 70) {
                    resultMessage.textContent = "Nice work! You know this rep pretty well.";
                } else if (pct >= 50) {
                    resultMessage.textContent = "Solid start. A few more laps through the playlist and you’re there.";
                } else {
                    resultMessage.textContent = "Tough set, but that’s what practice is for. Run it again!";
                }
                
                if (missedPieces.length > 0 && reviewMissedCheckbox.checked && !isReviewRound) {
                    missedTotalElement.textContent = missedPieces.length;
                    reviewSection.style.display = 'block';
                } else {
                    reviewSection.style.display = 'none';
                }

                modeSelect.disabled = false;
            }
            
            function restartQuiz() {
                results.style.display = 'none';
                quizSection.style.display = 'none';
                demoBtn.style.display = 'inline-block';
                const fileSection = document.querySelector('.file-input-section');
                if (fileSection) fileSection.style.display = 'flex';
                fileInput.value = '';
                fileCount.textContent = 'No files selected';
                scanReport.textContent = "";
                audioFiles = [];
                missedPieces = [];
                score = 0;
                totalPossiblePoints = 0;
                answeredCount = 0;
                missedCount = 0;
                updateProgress();
            }
        });
    </script>
</body>
</html>
